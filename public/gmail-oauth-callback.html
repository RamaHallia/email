<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Connexion Gmail...</title>
    <style>
      body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
        background: #f6fff8;
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }
      .card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 28px 32px;
        text-align: center;
        box-shadow: 0 10px 20px rgba(0,0,0,0.06);
        max-width: 400px;
      }
      .icon {
        width: 56px;
        height: 56px;
        border-radius: 9999px;
        background: #ecfdf5;
        color: #059669;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
        font-size: 30px;
      }
      .title {
        font-weight: 700;
        color: #065f46;
        margin-bottom: 4px;
        font-size: 18px;
      }
      .subtitle {
        color: #475569;
        font-size: 14px;
      }
      .spinner {
        border: 3px solid #ecfdf5;
        border-top: 3px solid #059669;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin: 16px auto 0;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .error .icon {
        background: #fef2f2;
        color: #dc2626;
      }
      .error .title {
        color: #991b1b;
      }
      .error {
        background: #fff7f7;
      }
      .error .card {
        border-color: #fecaca;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="icon">✓</div>
      <div class="title">Connexion Gmail en cours...</div>
      <div class="subtitle">Finalisation de la connexion...</div>
      <div class="spinner"></div>
    </div>
    <script>
      (async function () {
        try {
          const params = new URLSearchParams(window.location.search);
          const code = params.get('code');
          const state = params.get('state');

          if (!code || !state) {
            showError('Paramètres manquants (code/state).');
            setTimeout(() => window.close(), 2000);
            return;
          }

          const SUPABASE_URL = 'https://yliurdpexhvatzkgehvy.supabase.co';
          const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlsaXVyZHBleGh2YXR6a2dlaHZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4MzA4ODcsImV4cCI6MjA3NTQwNjg4N30.8T0VkYuAzLyd8_pQNPXToBlt2MMFV-irZ-cWIQ5vVDY';

          const resp = await fetch(`${SUPABASE_URL}/functions/v1/gmail-oauth-callback`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'apikey': ANON_KEY,
            },
            body: JSON.stringify({ code, state })
          });

          const result = await resp.json();

          if (!resp.ok) {
            if (result.isDuplicate) {
              showError('Ce compte Gmail est déjà configuré.');
              if (window.opener && !window.opener.closed) {
                window.opener.postMessage({ type: 'gmail-duplicate', email: result.email }, '*');
              }
              setTimeout(() => window.close(), 2000);
              return;
            }
            showError('Erreur: ' + (result.error || resp.status));
            if (window.opener && !window.opener.closed) {
              window.opener.postMessage({ type: 'gmail-error', error: result.error || String(resp.status) }, '*');
            }
            setTimeout(() => window.close(), 2000);
            return;
          }

          showSuccess(result.email);
          if (window.opener && !window.opener.closed) {
            window.opener.postMessage({ type: 'gmail-connected', email: result.email }, '*');
          }
          setTimeout(() => window.close(), 1000);
        } catch (e) {
          showError('Erreur: ' + (e && e.message ? e.message : e));
          setTimeout(() => window.close(), 2000);
        }
      })();

      function showSuccess(email) {
        document.querySelector('.icon').textContent = '✓';
        document.querySelector('.title').textContent = 'Connexion Gmail réussie';
        document.querySelector('.subtitle').textContent = 'Fermeture automatique...';
      }

      function showError(message) {
        document.body.classList.add('error');
        document.querySelector('.card').classList.add('error');
        document.querySelector('.icon').textContent = '!';
        document.querySelector('.title').textContent = 'Erreur';
        document.querySelector('.subtitle').textContent = message;
        const spinner = document.querySelector('.spinner');
        if (spinner) spinner.remove();
      }
    </script>
  </body>
</html>
